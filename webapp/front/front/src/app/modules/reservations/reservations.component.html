<div [class.dark-mode]="darkMode">
  <app-navbar></app-navbar>
  <div class="container">
    <div class="row init">
      <div class="column-left">
        <app-left-column></app-left-column>
      </div>

      <div class="column-middle">
        <div class="cool-static-container m-b-20" style="word-wrap: break-word;" aria-hidden="true">

          <!-- If no amenities -->
          <div class="no-posts-found" *ngIf="amenities?.length === 0 && !isLoading">
            <i class="circle-icon fa-solid fa-magnifying-glass"></i>
            Amenities not found
          </div>

          <!-- If amenities are available -->
          <div *ngIf="amenities?.length > 0">
            <h2>Make Reservation</h2>
            <div class="divider"></div>

            <form [formGroup]="reservationForm" (ngSubmit)="onSubmit()">
              <div class="col-md-12">
                <label for="amenityUrl" class="mt-3 mb-1">Select Amenity</label>
                <div class="amenity-scroll-container" (scroll)="onScroll($event)"
                  style="border:1px solid #ccc; max-height:200px; overflow-y:auto; padding:0.5rem;">

                  <div *ngFor="let entry of amenities" class="amenity-item"
                    [class.selected]="reservationForm.get('amenityUrl')?.value === entry.self"
                    (click)="selectAmenity(entry.self)"
                    style="cursor:pointer; padding:0.5rem; border-bottom:1px solid #eee;">
                    {{ entry.name }}
                  </div>

                  <div *ngIf="isLoading" class="loading-indicator" style="text-align:center; padding:1rem;">
                    Loading more amenities...
                  </div>
                </div>

                <p class="error"
                  *ngIf="reservationForm.get('amenityUrl')?.invalid && reservationForm.get('amenityUrl')?.touched">
                  Please select an amenity.
                </p>
              </div>

              <div class="col-md-12">
                <label for="date" class="mt-3 mb-1">Choose Date</label>
                <input type="date" id="date" formControlName="date" class="cool-input mb-1" required />
                <p class="error" *ngIf="reservationForm.get('date')?.invalid && reservationForm.get('date')?.touched">
                  Please choose a valid date.
                </p>
              </div>

              <div class="col-md-12">
                <div class="d-flex justify-content-end m-t-40">
                  <button type="submit" class="cool-button cool-small on-bg w-25 font-weight-bold" style="height:40px;">
                    See Times
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- The schedule table for each amenity -->
        <div *ngFor="let amenity of amenities" class="cool-static-container m-b-20" style="word-wrap: break-word;"
          aria-hidden="true">
          <h2>{{ amenity.name }}</h2>
          <p class="mb-3" style="color:var(--lighttext);">{{ amenity.description }}</p>

          <div class="d-flex flex-column justify-content-center align-items-center w-100">
            <div class="cool-table w-100">
              <table class="table-striped w-100">
                <tr>
                  <th>Amenity Hours</th>
                  <th *ngFor="let d of days">{{ d.label }}</th>
                </tr>
                <tr *ngFor="let t of times">
                  <td>{{ t.label }}</td>
                  <td *ngFor="let d of days">
                    <ng-container *ngIf="checkAvailability(amenity.availableShifts, d.key, t.key); else notAvailable">
                      <span style="color: var(--primary);" class="col-12">
                        <i class="fa-solid fa-check"></i>
                      </span>
                    </ng-container>
                    <ng-template #notAvailable>
                      <span style="color: var(--error);" class="col-12">
                        <i class="fa-solid fa-xmark"></i>
                      </span>
                    </ng-template>
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </div>

        <!-- PAGINATOR  -->
        <div class="m-t-20">
          <app-paginator [totalPages]="totalPages" [currentPage]="currentPage" (pageChange)="onPageChange($event)">
          </app-paginator>
        </div>

        <div *ngIf="showSuccessMessage">
          Reservation created successfully!
        </div>

        <div *ngIf="showErrorMessage">
          There was an error creating the reservation.
        </div>
      </div>

      <div class="column-right">
        <app-calendar-widget></app-calendar-widget>
        <div class="grey-static-container m-t-40">
          <div class="column d-flex justify-content-center align-items-center">
            <h3 class="m-b-20">My Reservations</h3>
            <div *ngIf="reservationsList?.length === 0" class="f-c-c-c align-items-center" style="text-align: center">
              <span class="w-100 mb-2">
                No reservations found
              </span>
            </div>
            <div *ngIf="reservationsList?.length > 0">
              <div *ngFor="let reservation of reservationsList" class="cool-static-container m-b-20"
                style="word-wrap: break-word;" aria-hidden="true">
                <div class="f-c-c-c">
                  <div class="f-r-sb-c w-100">
                    <h5>{{ reservation.amenity?.name }}</h5>
                  </div>
                  <div>
                    <h6 class="mb-3" style="color:var(--lighttext);">Date
                      <span class="c-primary">{{ reservation.bookingDate | date:'dd MMM yyyy' }}</span>
                    </h6>
                    <h6 class="mb-3" style="color:var(--lighttext);">Start Time
                      <span class="c-primary">{{ reservation.shift?.startTime | date:'HH:mm a' }}</span>
                    </h6>
                    <h6 class="mb-3" style="color:var(--lighttext);">End Time
                      <!-- If end time is always 1 hour after start time, you can derive it dynamically in your code -->
                      <span class="c-primary">{{ reservation.shift?.endTime | date:'HH:mm a' }}</span>
                    </h6>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- end column-right -->

    </div> <!-- end row -->
  </div> <!-- end container -->
</div>